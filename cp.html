<html>
	<head>
		<title>ChargePoint Simulator</title>
		<script type="text/javascript" src="assets/js/queryparam.js"></script>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
		<link rel="stylesheet" type="text/css" href="assets/css/main.css">
	</head>
	<body onload="useQueryParams()">
		<button id="connect">Connect</button>

	  <span>Status Notification</span>
		<select id="statusNotificationStatus">
			<option value="Available">Available</option>
			<option value="Occupied">Occupied</option>
			<option value="Reserved">Reserved</option>
			<option value="Unavailable">Unavailable</option>
			<option value="Faulted">Faulted</option>
		</select>
		<button id="status">Status Notification</button>

		<button id="heartbeat">Heartbeat</button>

    <span>Authorization Enabled</span>
		<input type="checkbox" name="checkboxAuthEnabled" id="checkboxAuthEnabled" onchange="onAuthenabledChange();">
		<!-- Not get supported <span>Id Token (from RFID card)</span>
		<input id="idToken" type="text" value="" />
		<button id="authorize">Authorize</button>-->

		<span>Meter Start</span><input id="meterStart" type="text" value="0" />
		<button id="startCablePluggedIn">Start Transaction - CablePluggedIn</button>
		<!-- Not yet supported <button id="startAuthorized">Start Transaction - Authorized</button>-->

		<button id="updateAuthorized">Update Transaction - Authorized</button>
		<!-- Not yet supported <button id="updateCablePluggedIn">Update Transaction - CablePluggedIn</button>-->
		<select id="chargingState">
			<option value="Charging">Charging</option>
			<option value="EVDetected">EVDetected</option>
			<option value="SuspendedEV">SuspendedEV</option>
			<option value="SuspendedEVSE">SuspendedEVSE</option>
		</select>
		<button id="updateChargingStateChanged">Update Transaction - ChargingStateChanged</button>

		<span>Meter Stop</span><input id="meterStop" type="text" value="2300" />
		<button id="stopEVCommunicationLost">Stop Transaction - EVCommunicationLost</button>

<!--
		<button id="data_transfer">Data Tranfer</button>
		<button id="mv">Meter Values</button>
		<button id="firmwarestatus">Firmware Status Notification</button>
		<button id="clearedChargingLimit">Cleared Charging Limit</button>
		<button id="logstatus_uploading">LogStatus Notification - Uploading</button>
		<button id="logstatus_uploaded">LogStatus Notification - Uploaded</button>
		<button id="notify_charging_limit">Notify Charging Limit - 10 A</button>
		<button id="notify_ev_charging_schedule">Notify EV Charging Schedule - 10 A</button>
-->

		<span>Endpoint URL</span><input id="endpointURL" type="text" value="" />
		<span>ID Chargepoint</span><input id="chargePointId" type="text" value="" />
		<span>EVSE ID</span><input id="evseId" type="text" value="1" />
		<span>Connector ID</span><input id="connectorId" type="text" value="1" />
		<span>Meter Value Unit</span><input id="meterValueUnit" type="text" value="Wh" />
		<span>Firmware Version</span><input id="firmwareVersion" type="text" value="0.9.87" />

		<div>
			<span class="indicator" id="red">____</span>
			<span class="indicator" id="green">____</span>
			<span class="indicator" id="blue">____</span>
			<span class="indicator" id="yellow">____</span>
		</div>
		<ul id="console"></ul>
		<script>
		$('.indicator').hide();
		$('#red').show();

		var c = 0;
		var start_id = "";
		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
		var id = randonId();
		var lastTranId;
		var _websocket = null;

		var connector_locked = false;

		function randonId() {
		    id = "";
		    for (var i = 0; i < 36; i++) {
		        id += possible.charAt(Math.floor(Math.random() * possible.length));
		    }
		    return id;
		}

		function guid() {
		    function s4() {
		        return Math.floor((1 + Math.random()) * 0x10000)
		            .toString(16)
		            .substring(1);
		    }
		    return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
		}

		function wsConnect() {

		    var endpointURL = $('#endpointURL').val();
				var chargePointId = $('#chargePointId').val();

		    if (_websocket) {
		        $('#red').show();
		        _websocket.close(3001);
		    } else {
		        _websocket = new WebSocket(endpointURL+""+chargePointId, ["ocpp2.0", "ocpp1.5"]);
		        _websocket.onopen = function(authorizationData) {

		            sessionStorage.setItem('LastAction', "BootNotification");
		            $('#yellow').show();
		            BootNotification();

		            $('#connect').text('Disconnect').css('background', 'green');

		        };

		        _websocket.onmessage = function(msg) {
		            c++;
		            var ddata = (JSON.parse(msg.data));

		            if (c == 1) {
		                var hb_interval = handleData(ddata);
		                sessionStorage.setItem("Confriguration", hb_interval);
		                startHB(hb_interval * 1000);
		            }

		            if (ddata[0] === 3) {
		                la = getLastAction();

		                if (la == "startTransaction") {

		                    ddata = ddata[2];
		                    logMsg("Data exchange successful!");
		                    var array = $.map(ddata, function(value, index) {
		                        return [value];
		                    });
		                    var TransactionId = (array[0]);
		                    sessionStorage.setItem('TransactionId', TransactionId);
		                }
		                logMsg("Response recieved successfully!");
		            } else if ((JSON.parse(msg.data))[0] === 4) {
		                logMsg("Data exchange failed - JSON is not accepted!");
		            } else if ((JSON.parse(msg.data))[0] === 2) {
									// Request from CSMS to CS

										var receivedMessageId = ddata[1];
										var receivedMessageAction = ddata[2];
										var receivedMessagePayload= ddata[3];

										logMsg(msg.data); // log message data

		                switch (ddata[2]) {
		                    case "ChangeAvailability":
		                        var changeAvail = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(changeAvail);
		                        break;
		                    case "ClearCache":
		                        var clearCache = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(clearCache);
		                        break;
		                    case "GetLog":
		                        var getLog = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted",
		                            "filename": "somefile.txt"
		                        }]);
		                        _websocket.send(getLog);
		                        break;
		                    case "RequestStartTransaction":
		                        var reqStartTrans = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(reqStartTrans);
		                        startTransaction();
		                        break;
		                    case "RequestStopTransaction":
		                        var reqStopTrans = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(reqStopTrans);

		                        var stop_id = (JSON.parse(msg.data)[3].transactionId);
		                        stopTransaction(stop_id);
		                        break;
		                    case "Reset":
		                        var ResetS = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(ResetS);
		                        //location.reload();
		                        break;
		                    case "UnlockConnector":
		                        var unlockCon = JSON.stringify([3, receivedMessageId, {
		                            "status": "Unlocked"
		                        }]);
		                        _websocket.send(unlockCon);
		                        connector_locked = false;
		                        $('.indicator').hide();
		                        $('#yellow').show();
		                        logMsg("Connector status changed to: " + connector_locked);
		                        statusNotification();
		                        break;
		                    case "UpdateFirmware":
		                        var updFirm = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(updFirm);
		                        break;
		                    case "ReserveNow":
		                        var resNow = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(resNow);
		                        break;
		                    case "CancelReservation":
		                        var cancelRes = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(cancelRes);
		                        break;
		                    case "DataTransfer":
		                        var dataTrans = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted",
		                            "data": "some data"
		                        }]);
		                        _websocket.send(dataTrans);
		                        break;
		                    case "GetVariables":
														var responsePayload = {};
														switch (receivedMessagePayload.getVariableData[0].variable.name) {
															case "Enabled":
																	// component AuthCtrlr is not checked here, but assumed
																	var authEnabled = getAuthEnabled();
																	var authEnabledString = (new Boolean(authEnabled)).toString();
																	responsePayload.getVariableResult = [
														         {
														            "attributeStatus":"Accepted",
														            "variable":{
														               "name":"Enabled"
														            },
														            "attributeValue":authEnabledString,
														            "component":{
														               "name":"AuthCtrlr"
														            }
														         }
														      ];
																break;
															default:
														}
														var getVars = JSON.stringify([3, receivedMessageId, responsePayload]);
														logMsg(getVars);
		                        _websocket.send(getVars);
		                        break;
		                    case "SetVariables":
														var componentName = receivedMessagePayload.setVariableData[0].component.name;
														var variableName = receivedMessagePayload.setVariableData[0].variable.name;
														var attributeValue = receivedMessagePayload.setVariableData[0].attributeValue;

														var attributeStatus = setVariable(componentName, variableName, attributeValue);

		                        var setVar = JSON.stringify([3, receivedMessageId, {
		                            "setVariableResult": [{
		                                "attributeStatus": attributeStatus,
		                                "component": {
		                                    "name": componentName
		                                },
		                                "variable": {
		                                    "name": variableName
		                                }
		                            }]
		                        }]);
		                        _websocket.send(setVar);
		                        break;
		                    case "GetLocalListVersion":
		                        var gLocList = JSON.stringify([3, receivedMessageId, {
		                            "versionNumber": 0
		                        }]);
		                        _websocket.send(gLocList);
		                        break;
		                    case "SendLocalList":
		                        var sendLocList = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(sendLocList);
		                        break;
		                    case "TriggerMessage":
		                        var triggerMsg = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(triggerMsg);

		                        var req_message = (JSON.parse(msg.data)[3].requestedMessage);
		                        if (req_message == "BootNotification") {
		                            BootNotification();
		                        }
		                        if (req_message == "LogStatusNotification") {}
		                        if (req_message == "FirmwareStatusNotification") {
		                            FirmwareStatusNotification();
		                        }
		                        if (req_message == "Heartbeat") {
		                            send_heartbeat();
		                        }
		                        if (req_message == "MeterValues") {
		                            meterValues();
		                        }
		                        if (req_message == "SignChargingStationCertificate") {}
		                        if (req_message == "SignV2GCertificate") {}
		                        if (req_message == "StatusNotification") {
		                            statusNotification();
		                        }
		                        if (req_message == "TransactionEvent") {}
		                        break;
		                    case "GetCompositeSchedule":
		                        var getComp = JSON.stringify([3, receivedMessageId, {
		                            "status": 'Accepted',
		                            "evseId": 0,
		                            "schedule": {
		                                "startDateTime": formatDate(new Date()),
		                                "chargingSchedule": {
		                                    "duration": 86400,
		                                    "chargingRateUnit": "W",
		                                    "chargingSchedulePeriod": [{
		                                        "startPeriod": 0,
		                                        "limit": 11000,
		                                        "numberPhases": 3
		                                    }, {
		                                        "startPeriod": 28800,
		                                        "limit": 6000,
		                                        "numberPhases": 3
		                                    }, {
		                                        "startPeriod": 72000,
		                                        "limit": 11000,
		                                        "numberPhases": 3
		                                    }]
		                                }
		                            }
		                        }]);
		                        _websocket.send(getComp);
		                        break;
		                    case "ClearChargingProfile":
		                        var clearChargPrfl = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(clearChargPrfl);
		                        break;
		                    case "SetChargingProfile":
		                        var setChargPrlf = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(setChargPrlf);
		                        break;
		                    case "CertificateSigned":
		                        var certSigned = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(certSigned);
		                        break;
		                    case "ClearDisplayMessage":
		                        var clearDispMsg = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(clearDispMsg);
		                        break;
		                    case "ClearVariableMonitoring":
		                        var clearVarMon = JSON.stringify([3, receivedMessageId, {
		                            "clearMonitoringResult": [{
		                                "id": 1,
		                                "status": "Accepted"
		                            }, {
		                                "id": 2,
		                                "status": "Rejected"
		                            }, {
		                                "id": 3,
		                                "status": "NotFound"
		                            }]
		                        }]);
		                        _websocket.send(clearVarMon);
		                        break;
		                    case "GetBaseReport":
		                        var getBaseRep = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(getBaseRep);
		                        break;
		                    case "CostUpdated":
		                        var costUpdtd = JSON.stringify([3, receivedMessageId, {}]);
		                        _websocket.send(costUpdtd);
		                        break;
		                    case "GetMonitoringReport":
		                        var getMonRep = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(getMonRep);
		                        break;
		                    case "GetReport":
		                        var getRep = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(getRep);
		                        break;
		                    case "SetMonitoringBase":
		                        var setMonBase = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(setMonBase);
		                        break;
		                    case "SetMonitoringLevel":
		                        var setMonLevel = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(setMonLevel);
		                        break;
		                    case "SetVariableMonitoring":
		                        var setVarMon = JSON.stringify([3, receivedMessageId, {
		                            "setMonitoringResult": [{
		                                "id": 1,
		                                "type": "Periodic",
		                                "severity": 9,
		                                "status": "Accepted",
		                                "component": {
		                                    "name": "some component"
		                                },
		                                "variable": {
		                                    "name": "some variable"
		                                }
		                            }]
		                        }]);
		                        _websocket.send(setVarMon);
		                        break;
		                    case "UnpublishFirmware":
		                        var unpFirm = JSON.stringify([3, receivedMessageId, {
		                            "status": "Unpublished"
		                        }]);
		                        _websocket.send(unpFirm);
		                        break;
		                    case "CustomerInformation":
		                        var custmrInfo = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(custmrInfo);
		                        break;
		                    case "SetDisplayMessage":
		                        var setmessage = (JSON.parse(msg.data)[3].message.message.content);
		                        logMsg("Display message: <b><i>" + setmessage + "</i></b>");
		                        var setDispMsg = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(setDispMsg);
		                        break;
		                    case "DeleteCertificate":
		                        var delCert = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(delCert);
		                        break;
		                    case "GetChargingProfiles":
		                        var getChargPrfl = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(getChargPrfl);
		                        break;
		                    case "GetDisplayMessages":
		                        var getDispMsg = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(getDispMsg);
		                        break;
		                    case "GetInstalledCertificateIds":
		                        var getInstalledCertIds = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(getInstalledCertIds);
		                        break;
		                    case "GetTransactionStatus":
		                        var getTranStat = JSON.stringify([3, receivedMessageId, {
		                            "messagesInQueue": "true"
		                        }]);
		                        _websocket.send(getTranStat);
		                        break;
		                    case "InstallCertificate":
		                        var installCert = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(installCert);
		                        break;
		                    case "NotifyCentralChargingNeeds":
		                        var noCentChargNeed = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(noCentChargNeed);
		                        break;
		                    case "PublishFirmware":
		                        var pubFirmware = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(pubFirmware);
		                        break;
		                    case "Renegotiate15118Schedule":
		                        var renSchedule = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(renSchedule);
		                        break;
		                    case "SetNetworkProfile":
		                        var setNetProfl = JSON.stringify([3, receivedMessageId, {
		                            "status": "Accepted"
		                        }]);
		                        _websocket.send(setNetProfl);
		                        break;
		                    default:
		                        var error = JSON.stringify([4, receivedMessageId]);
		                        _websocket.send(error);
		                        break;
		                }
		            }
		        };

		        _websocket.onclose = function(evt) {
		            $('#connect').text('Connect').css('background', '#369');
		            if (evt.code == 3001) {
		                logMsg('ws closed');
		                _websocket = null;
		            } else {
		                logMsg('ws connection error: ' + evt.code);
		                $('#console').html("");
		                _websocket = null;
		            }
		            //
		        };

		        _websocket.onerror = function(evt) {
		            if (_websocket.readyState == 1) {
		                $('#red').show();
		                logMsg('ws normal error: ' + evt.type);
		            }
		        };
		    }
		}

		function logMsg(err) {
		    console.log(err);
		    $('#console').append('<li>' + err + '</li>');
		}

		function Authorize() {

		    sessionStorage.setItem('LastAction', "Authorize");
		    var Auth = JSON.stringify([2, id, "Authorize", {
		        "idToken": {
		            "idToken": $('#idToken').val(),
		            "type": "ISO15693"
		        }
		    }]);
		    _websocket.send(Auth);

		}

		function FirmwareStatusNotification() {

		    sessionStorage.setItem('LastAction', "FirmwareStatusNotification");
		    var FirmStat = JSON.stringify([2, id, "FirmwareStatusNotification", {
		        "status": "Installed",
		        "requestId": "0"
		    }]);
		    _websocket.send(FirmStat);

		}

		function getEvseObject() {
		    return {
		        "id": Number.parseInt($('#evseId').val()),
		        "connectorId": Number.parseInt($('#connectorId').val())
		    };
		}

		function getMeterValueSampleObject(startValue, stopValue = null) {
		    var meterValueSampleObject =  [];

				if(startValue != null) {
					meterValueSampleObject.push({
			        "timestamp": formatDate(new Date()),
			        "sampledValue": [{
			            "value": startValue,
									"context": "Transaction.Begin",
			            "unitOfMeasure": {
			                "unit": $('#meterValueUnit').val()
			            }
			        }]
			    });
				}

				if(stopValue != null) {
					meterValueSampleObject.push({
			        "timestamp": formatDate(new Date()),
			        "sampledValue": [{
			            "value": stopValue,
									"context": "Transaction.End",
			            "unitOfMeasure": {
			                "unit": $('#meterValueUnit').val()
			            }
			        }]
			    });
				}

				return meterValueSampleObject;
		}

		function getIdToken() {
		    return $('#idToken').val();
		}

		function getAuthEnabled() {
			return $('#checkboxAuthEnabled').is(':checked');

		}

		function setAuthEnabled(enabled) {
			logMsg("Changed AuthEnabled to: " + enabled);
			$("#checkboxAuthEnabled").prop("checked", enabled);
		}

		function getIdTokenObject() {
		    var idTokenObject;

		    if (getAuthEnabled()) {
		        idTokenObject = {
		            "idToken": getIdToken(),
		            "type": "ISO15693"
		        };
		    } else {
		        idTokenObject = {
		            "idToken": "",
		            "type": "NoAuthorization"
		        };
		    }

		    return idTokenObject;
		}

		function getTransactionDataObject(transactionId, chargingState) {
		    var transactionDataObject;
        transactionDataObject = {
					"id": transactionId
        };

				if(chargingState) {
					transactionDataObject.chargingState = chargingState;
				}

		    return transactionDataObject;
		}

		function setVariable(componentName, variableName, attributeValue) {
			if(componentName == "AuthCtrlr" && variableName == "Enabled") {
				switch (attributeValue) {
					case "true":
						setAuthEnabled(true);
						return "Accepted";
						break;
					case "false":
						setAuthEnabled(false);
						return "Accepted";
						break;
					default:
						return "InvalidValue";
				}
			}
		}

		function startTransaction(triggerReason = "CablePluggedIn", chargingState = "EVDetected") {
		    sessionStorage.setItem('LastAction', "startTransaction");
		    $('.indicator').hide();
		    $('#green').show();
		    connector_locked = true;
		    logMsg("Connector status changed to: " + connector_locked);
		    lastTranId = guid();
		    var json = {
		        "eventType": "Started",
		        "timestamp": formatDate(new Date()),
		        "triggerReason": triggerReason,
		        "seqNo": 0
		    };
				json.transactionData = getTransactionDataObject(lastTranId, chargingState);
		    json.evse = getEvseObject();
		    json.meterValue = getMeterValueSampleObject(Number.parseInt($('#meterStart').val()));

		    if (triggerReason == "Authorized" || triggerReason == "StopAuthorized") {
		        json.idToken = getIdTokenObject();
		    }

		    var strtT = JSON.stringify([2, id, "TransactionEvent", json]);
		    _websocket.send(strtT);
		}

		function updateTransaction(triggerReason = "MeterValuePeriodic", chargingState = "Charging") {
		    sessionStorage.setItem('LastAction', "updateTransaction");
		    var json = {
		        "eventType": "Updated",
		        "timestamp": formatDate(new Date()),
		        "triggerReason": triggerReason,
		        "seqNo": 0
		    };

				json.transactionData = getTransactionDataObject(lastTranId, chargingState);
		    json.evse = getEvseObject();

				if (triggerReason == "Authorized" || triggerReason == "StopAuthorized") {
		        json.idToken = getIdTokenObject();
		    }

		    var updTrns = JSON.stringify([2, id, "TransactionEvent", json]);
		    _websocket.send(updTrns);
		}

		function stopTransaction(transaction_id = false, triggerReason = "EVCommunicationLost") {
		    sessionStorage.setItem('LastAction', "stopTransaction");
		    transaction_id == false ? lastTranId = lastTranId : lastTranId = transaction_id;
		    $('.indicator').hide();
		    connector_locked = false;
		    logMsg("Connector status changed to: " + connector_locked);
		    $('#yellow').show();
		    var json = {
		        "eventType": "Ended",
		        "timestamp": formatDate(new Date()),
		        "triggerReason": triggerReason,
		        "seqNo": 0
		    };

				json.transactionData = getTransactionDataObject(lastTranId);
				json.transactionData.stoppedReason = "EVDisconnected";
		    json.evse = getEvseObject();
		    json.meterValue = getMeterValueSampleObject(Number.parseInt($('#meterStart').val()), Number.parseInt($('#meterStop').val()));

		    var stpT = JSON.stringify([2, id, "TransactionEvent", json]);
		    _websocket.send(stpT);
		}

		function getConfiguration() {

		}

		function handleData(data, request = false) {
		    var lastAction = getLastAction();
		    if (lastAction = "BootNotification") {
		        data = data[2];
		        heartbeat_interval = data.interval;
		        return heartbeat_interval;
		    } else if (lastAction = "StartTransaction") {
		        return "StartTransaction";
		    } else if (1 == 2) {
		        alert("else");
		    }

		}

		function getLastAction() {
		    var LastAction = sessionStorage.getItem("LastAction");
		    return LastAction;
		}

		function BootNotification() {

		    var BN = JSON.stringify([2, id, "BootNotification", {
		        "chargingStation": {
		            "serialNumber": "avt.001.13.1",
		            "model": "AVT-Express",
		            "modem": {
		                "iccid": "MMCC IINN NNNN NNNN NN C x",
		                "imsi": "520031234567890"
		            },
		            "vendorName": "AVT-Company",
		            "firmwareVersion": $('#firmwareVersion').val()
		        },
		        "reason": "PowerUp"
		    }]);

		    logMsg('ws connected');

		    _websocket.send(BN);
		}

		function statusNotification() {
		    sessionStorage.setItem('LastAction', "StatusNotification");
		    var SN = JSON.stringify([2, id, "StatusNotification", {
		        "timestamp": formatDate(new Date()),
		        "connectorStatus": $('#statusNotificationStatus').val(),
		        "evseId": Number.parseInt($('#evseId').val()),
		        "connectorId": Number.parseInt($('#connectorId').val())
		    }]);
		    _websocket.send(SN);
		}

		function meterValues() {
		    sessionStorage.setItem('LastAction', "MeterValues");
		    var MV = JSON.stringify([2, id, "MeterValues", {
		        "evseId": 2,
		        "meterValue": [{
		            "timestamp": formatDate(new Date()),
		            "sampledValue": [{
		                "value": "0",
		                "measurand": "Energy.Active.Import.Register"
		            }, {
		                "value": "0",
		                "measurand": "Energy.Reactive.Import.Register"
		            }]
		        }, {
		            "timestamp": formatDate(new Date()),
		            "sampledValue": [{
		                "value": "20",
		                "measurand": "Energy.Active.Import.Register"
		            }, {
		                "value": "20",
		                "measurand": "Energy.Reactive.Import.Register"
		            }]
		        }]
		    }]);
		    _websocket.send(MV);
		}

		function startHB(interval) {
		    setInterval(send_heartbeat, interval);
		}

		function send_heartbeat() {
		    sessionStorage.setItem('LastAction', "Heartbeat");
		    var HB = JSON.stringify([2, id, "Heartbeat", {}]);
		    _websocket.send(HB);
		}

		function LogStatusNotification(upload_status = "Uploading") {
		    sessionStorage.setItem('LastAction', "LogStatusNotification");
		    var LSN = JSON.stringify([2, id, "LogStatusNotification", {
		        "status": upload_status,
		        "requestId": 1,
		    }]);
		    _websocket.send(LSN);
		}

		function NotifyChargingLimit(charge_limit = 10, limit_source = "SO") {
		    sessionStorage.setItem('LastAction', "NotifyChargingLimit");
		    var LSN = JSON.stringify([2, id, "NotifyChargingLimit", {
		        "evseId": 1,
		        "chargingLimit": {
		            "chargingLimitSource": limit_source,
		            "isGridCritical": "False",
		        },
		        "chargingSchedule": charging_schedule(charge_limit)
		    }]);
		    _websocket.send(LSN);
		}

		function NotifyEVChargingSchedule(charge_limit = 10, evse_id = 1) {
		    sessionStorage.setItem('LastAction', "NotifyEVChargingSchedule");
		    var NECS = JSON.stringify([2, id, "NotifyEVChargingSchedule", {
		        "evseId": evse_id,
		        "timeBase": formatDate(new Date()),
		        "chargingSchedule": charging_schedule(charge_limit)
		    }]);
		    _websocket.send(NECS);
		}

		function charging_schedule(charge_limit) {
		    return {
		        "chargingRateUnit": "A",
		        "chargingSchedulePeriod": {
		            "startPeriod": 0,
		            "limit": charge_limit
		        }
		    }
		}

		$('#connect').click(function() {
		    $('.indicator').hide();
		    $('#console').html("");
		    wsConnect();
		});

		$('#authorize').click(function() {
		    Authorize();
		});

		$('#startCablePluggedIn').click(function() {
		    startTransaction(triggerReason = "CablePluggedIn", chargeState = "EVDetected");
		});

		$('#startAuthorized').click(function() {
		    // This is OCPP 2.0.0, In OCPP 2.0.1 "Idle" would be the correct value
		    startTransaction(triggerReason = "Authorized", chargeState = "EVDetected");
		});

		$('#updateAuthorized').click(function() {
		    state = $('#chargingState').val();
		    updateTransaction(triggerReason = "Authorized", chargingState = null);
		});

		$('#updateCablePluggedIn').click(function() {
		    state = $('#chargingState').val();
		    updateTransaction(triggerReason = "CablePluggedIn", chargingState = state);
		});

		$('#updateChargingStateChanged').click(function() {
		    state = $('#chargingState').val();
		    updateTransaction(triggerReason = "ChargingStateChanged", chargingState = state);
		});

		$('#stopEVCommunicationLost').click(function() {
		    stopTransaction();
		});

		$('#firmwarestatus').click(function() {
		    FirmwareStatusNotification();
		});

		$('#mv').click(function() {
		    meterValues();
		});
		$('#heartbeat').click(function() {
		    send_heartbeat();

		});

		$('#status').click(function() {
		    statusNotification();
		});

		$('#data_transfer').click(function() {
		    sessionStorage.setItem('LastAction', "DataTransfer");
		    var DT = JSON.stringify([2, id, "DataTransfer", {
		        "vendorId": "rus.avt.cp",
		        "messageId": "GetChargeInstruction",
		        "data": ""
		    }]);
		    _websocket.send(DT);

		});

		$('#clearedChargingLimit').click(function() {
		    sessionStorage.setItem('LastAction', "ClearedChargingLimit");
		    var CCL = JSON.stringify([2, id, "ClearedChargingLimit", {
		        "chargingLimitSource": "Other",
		        "evseId": "2"
		    }]);
		    _websocket.send(CCL);

		});

		$('#logstatus_uploading').click(function() {
		    LogStatusNotification();
		});

		$('#logstatus_uploaded').click(function() {
		    LogStatusNotification("Uploaded");
		});

		$('#notify_charging_limit').click(function() {
		    NotifyChargingLimit();
		});

		$('#notify_ev_charging_schedule').click(function() {
		    NotifyEVChargingSchedule();
		});



		$('#connect').on('change', function() {

		    if (_websocket) {
		        _websocket.close(3001);
		    }
		});


		// log authorization enabled changes
		function onAuthenabledChange() {
			logMsg("Authorization Enabled changed to: " + getAuthEnabled());
		}

		function formatDate(date) {

			return date.toISOString();
		}

		</script>
	</body>
</html>
